
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đọc hiểu tiếng Nga</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QGGYC336VD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QGGYC336VD');
</script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px_12px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            width: 100%;
            max-width: 900px;
            overflow: hidden;
        }
        .text-content {
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            word-wrap: break-word; /* Break long words */
            line-height: 1.6;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            min-height: 300px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .text-content span.word-clickable {
            cursor: pointer;
            padding: 2px 0;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .text-content span.word-clickable:hover {
            background-color: #e0e7ff; /* Light blue on hover */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.0);
            z-index: 999;
            display: none;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            position: absolute;
            max-width: 280px;
            z-index: 1000;
            border: 1px solid #e5e7eb;
            animation: fadeIn 0.2s ease-out;
            cursor: grab;
            position: relative;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .button-base {
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
        }
        .button-base:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button-base:hover:not(:disabled) {
             transform: translateY(-1px);
        }
        .button-base:active:not(:disabled) {
            transform: translateY(0);
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #4338ca;
        }
        .button-secondary {
            background-color: #6b7280;
            color: white;
        }
        .button-secondary:hover:not(:disabled) {
            background-color: #4b5563;
        }
        .link-button {
            display: block;
            background-color: #eff6ff;
            color: #1d4ed8;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.9rem;
        }
        .link-button:hover {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .section-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        #ai-results-section, #explanation-section, #stressed-text-section, #reference-section {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e5e7eb;
        }
        #google-translate-result, #selection-translate-result {
            margin-top: 10px;
            padding: 8px;
            background-color: #f0f4f8;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #333;
            border: 1px solid #d1e0ed;
        }
        .text-selection-popup {
            max-width: 320px; 
            padding: 10px;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: grab;
            position: absolute;
            z-index: 1001;
        }
        .text-selection-popup .button-secondary,
        .text-selection-popup .button-primary {
            padding: 6px 10px;
            font-size: 0.8rem;
            width: 100%;
        }
        .close-button {
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
            padding: 2px;
        }
        .close-button:hover {
            color: #374151;
        }
        .tts-controls {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            background-color: #f9fafb;
        }
        #tts-progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            cursor: pointer;
            height: 10px;
        }
        #tts-progress-bar {
            height: 100%;
            background-color: #4f46e5;
            border-radius: 9999px;
            width: 0%;
            transition: width 0.1s linear;
        }
        #reference-section ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        #reference-section li {
            margin-bottom: 0.5rem;
        }
        #reference-section a {
            color: #3b82f6;
            text-decoration: underline;
        }
        #reference-section a:hover {
            color: #1d4ed8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Đọc hiểu tiếng Nga</h1>

        <!-- Controls Section -->
        <div class="space-y-4 mb-4">
            <!-- Row 1: Data Input -->
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <!-- File Upload -->
                <div class="flex items-center space-x-2">
                    <label for="file-upload" class="button-base button-secondary cursor-pointer">Tải lên tệp tin</label>
                    <input type="file" id="file-upload" class="hidden" accept=".txt,.docx">
                    <span id="file-name" class="text-gray-600 text-sm"></span>
                </div>
                <!-- URL Input -->
                <div class="flex items-center space-x-2 flex-grow">
                    <input type="url" id="web-url-input" placeholder="Hoặc dán URL trang web vào đây" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full">
                    <button id="fetch-url-button" class="button-base button-primary">Đọc web</button>
                </div>
            </div>
            <!-- Row 2: Text Area Input -->
            <div class="mt-2">
                <label for="text-input-area" class="block mb-2 text-sm font-medium text-gray-700">Hoặc nhập văn bản trực tiếp:</label>
                <textarea id="text-input-area" rows="5" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="Dán hoặc gõ văn bản tiếng Nga của bạn vào đây..."></textarea>
                <button id="process-text-button" class="button-base button-primary mt-2">Xử lý văn bản</button>
            </div>
            <!-- Row 3: Tools -->
            <div class="flex flex-wrap items-center justify-center gap-4 pt-4">
                <button id="stress-mark-button" class="button-base button-secondary">Đánh trọng âm</button>
                <button id="explain-text-button" class="button-base button-secondary">Giải thích (AI)</button>
            </div>
             <!-- Row 4: Text-to-Speech Controls -->
            <div class="tts-controls mt-4 space-y-3">
                <h3 class="text-lg font-medium text-center">Công cụ đọc thành tiếng</h3>
                <!-- Player Controls -->
                <div class="flex items-center gap-4">
                    <button id="tts-play-pause" class="button-base button-primary flex items-center justify-center w-28">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1zm6 0a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span id="play-pause-text" class="ml-2">Phát</span>
                    </button>
                    <button id="tts-stop" class="button-base button-secondary">Dừng</button>
                    <div id="tts-progress-container" class="flex-grow">
                        <div id="tts-progress-bar"></div>
                    </div>
                </div>
                <!-- Settings -->
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <div class="flex items-center space-x-2">
                        <label for="tts-voice" class="text-sm font-medium">Giọng:</label>
                        <select id="tts-voice" class="p-2 border border-gray-300 rounded-md shadow-sm text-sm"></select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="tts-rate" class="text-sm font-medium">Tốc độ:</label>
                        <input type="range" id="tts-rate" min="0.5" max="2" value="1" step="0.1" class="w-24">
                        <span id="tts-rate-label" class="text-sm font-mono">1.0x</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="text-display" class="text-content">
            <!-- Text content will be loaded here -->
            Vui lòng tải lên một tệp tin hoặc nhập một URL để bắt đầu.
        </div>

        <!-- AI Generation Section -->
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-3 text-gray-800 text-center">Tạo câu và từ liên quan (AI)</h3>
            <div class="flex items-center gap-2">
                <input type="text" id="ai-custom-input" placeholder="Nhập từ hoặc cụm từ..." class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full">
                <button id="ai-generate-custom-button" class="button-base button-primary">Tạo</button>
            </div>
             <div id="loading-spinner" class="loading-spinner"></div>
            <div id="ai-results-section" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-md text-gray-700 hidden">
                <div class="section-header">
                    <h3>Kết quả AI</h3>
                    <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
                </div>
                <div id="ai-text-content" class="section-content text-left"></div>
            </div>
        </div>

        <!-- Stressed Text Section -->
        <div id="stressed-text-section" class="mt-8 hidden">
            <div class="section-header">
                <h3>Văn bản với trọng âm (AI)</h3>
                <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
            </div>
            <div id="stressed-content" class="text-gray-700 text-content section-content"></div>
            <div id="stressed-loading-spinner" class="loading-spinner"></div>
        </div>
        
        <!-- AI Explanation Section -->
        <div id="explanation-section" class="mt-8 hidden">
            <div class="section-header">
                <h3>Giải thích nội dung văn bản (AI)</h3>
                <button class="toggle-button button-base button-secondary text-xs px-2 py-1">Thu gọn</button>
            </div>
            <div id="explanation-content" class="text-gray-700 section-content"></div>
            <div id="explanation-loading-spinner" class="loading-spinner"></div>
        </div>

        <!-- Reference Section -->
        <div id="reference-section">
            <h3 class="text-xl font-semibold mb-3 text-gray-800">Trang web tham khảo</h3>
            <ul>
                <li><a href="https://russiangram.com" target="_blank">RussianGram.com</a> - Công cụ kiểm tra trọng âm và chia động từ tiếng Nga.</li>
                <li><a href="http://gramota.ru/" target="_blank">Gramota.ru</a> - Cổng thông tin uy tín về ngôn ngữ Nga, bao gồm từ điển và kiểm tra chính tả.</li>
                <li><a href="https://en.wiktionary.org/wiki/Wiktionary:Main_Page" target="_blank">Wiktionary</a> - Từ điển mở đa ngôn ngữ, cung cấp thông tin chi tiết về từ nguyên, phát âm và cách sử dụng.</li>
                <li><a href="https://www.wordreference.com/" target="_blank">WordReference</a> - Từ điển song ngữ phổ biến với nhiều ví dụ và diễn đàn thảo luận.</li>
               <li>*Website này được tạo ra bởi <a href="https://www.facebook.com/lopmaybay" target="_blank">Phạm Đăng Hiển</a>, mọi góp ý xin liên hệ lopmaybay@gmail.com </li>
            </ul>
        </div>


        <!-- Word Lookup Modal -->
        <div id="lookup-modal" class="modal-overlay">
            <div id="modal-content-inner" class="modal-content">
                <button id="close-lookup-modal" class="close-button" title="Đóng">&times;</button>
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Tra cứu từ: <span id="selected-word-modal" class="font-bold text-indigo-600"></span></h2>
                <div class="space-y-2">
                    <a id="vtudien-link" href="#" target="_blank" class="link-button">Tra từ điển (vtudien.com)</a>
                    <a id="youglish-link" href="#" target="_blank" class="link-button">Tra YouGlish</a>
                    <a id="wiktionary-link" href="#" target="_blank" class="link-button">Tra Wiktionary</a>
                </div>
                <div id="google-translate-result" class="mt-4"></div>
                <div id="translate-loading-spinner" class="loading-spinner"></div>
            </div>
        </div>

        <!-- Text Selection Popup -->
        <div id="selection-popup" class="modal-content text-selection-popup hidden">
            <button id="close-selection-popup" class="close-button" title="Đóng">&times;</button>
            <div class="flex flex-col space-y-2">
                <button id="copy-selection-button" class="button-base button-secondary w-full">Sao chép</button>
                <button id="translate-selection-button" class="button-base button-primary w-full">Dịch</button>
            </div>
            <div id="selection-translate-result" class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded-md text-gray-700 text-sm hidden"></div>
            <div id="selection-translate-spinner" class="loading-spinner"></div>
        </div>
    </div>

    <!-- External libraries moved to the end of body -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
    
    <!-- Firebase SDK Compat libraries for global access -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <!-- Main App Logic -->
    <script>
        // --- Application Logic ---
        function mainApp() {
            // Global variables for Firebase (MANDATORY)
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
            let auth;
            let db;
            let userId = null;
            let isAuthReady = false;
    
            // Initialize Firebase
            if (Object.keys(firebaseConfig).length > 0 && typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
    
                // Listen for auth state changes
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await auth.signInWithCustomToken(initialAuthToken);
                            } else {
                                await auth.signInAnonymously();
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                        }
                    }
                    isAuthReady = true;
                });
            } else {
                console.warn("Firebase config not found or Firebase library not loaded. Firebase services will not be available.");
                isAuthReady = true;
                userId = crypto.randomUUID();
            }

            const textDisplay = document.getElementById('text-display');
            const stressMarkButton = document.getElementById('stress-mark-button');
            const explainTextButton = document.getElementById('explain-text-button');
            const lookupModalOverlay = document.getElementById('lookup-modal');
            const modalContentInner = document.getElementById('modal-content-inner');
            const selectedWordModalSpan = document.getElementById('selected-word-modal');
            const vtudienLink = document.getElementById('vtudien-link');
            const youglishLink = document.getElementById('youglish-link');
            const wiktionaryLink = document.getElementById('wiktionary-link');
            const googleTranslateResultDiv = document.getElementById('google-translate-result');
            const translateLoadingSpinner = document.getElementById('translate-loading-spinner');
            const aiCustomInput = document.getElementById('ai-custom-input');
            const aiGenerateCustomButton = document.getElementById('ai-generate-custom-button');
            const loadingSpinner = document.getElementById('loading-spinner');
            const aiResultsSection = document.getElementById('ai-results-section');
            const aiTextContentDiv = document.getElementById('ai-text-content');
            const explanationSection = document.getElementById('explanation-section');
            const explanationContentDiv = document.getElementById('explanation-content');
            const explanationLoadingSpinner = document.getElementById('explanation-loading-spinner');
            const stressedTextSection = document.getElementById('stressed-text-section');
            const stressedContentDiv = document.getElementById('stressed-content');
            const stressedLoadingSpinner = document.getElementById('stressed-loading-spinner');
            const fileUploadInput = document.getElementById('file-upload');
            const fileNameSpan = document.getElementById('file-name');
            const selectionPopup = document.getElementById('selection-popup');
            const copySelectionButton = document.getElementById('copy-selection-button');
            const translateSelectionButton = document.getElementById('translate-selection-button');
            const selectionTranslateResultDiv = document.getElementById('selection-translate-result');
            const selectionTranslateSpinner = document.getElementById('selection-translate-spinner');
            const webUrlInput = document.getElementById('web-url-input');
            const fetchUrlButton = document.getElementById('fetch-url-button');
            const closeLookupModalBtn = document.getElementById('close-lookup-modal');
            const closeSelectionPopupBtn = document.getElementById('close-selection-popup');
            const textInputArea = document.getElementById('text-input-area');
            const processTextButton = document.getElementById('process-text-button');
            
            // TTS Controls
            const ttsPlayPauseBtn = document.getElementById('tts-play-pause');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const playPauseText = document.getElementById('play-pause-text');
            const ttsStopBtn = document.getElementById('tts-stop');
            const ttsVoiceSelect = document.getElementById('tts-voice');
            const ttsRateSlider = document.getElementById('tts-rate');
            const ttsRateLabel = document.getElementById('tts-rate-label');
            const ttsProgressContainer = document.getElementById('tts-progress-container');
            const ttsProgressBar = document.getElementById('tts-progress-bar');

            let currentRawText = '';
            let justEndedDrag = false;
            let voices = [];
            let speechStartIndex = 0;

            function makeDraggable(element) {
                let isDragging = false;
                let initialMouseX, initialMouseY, initialElementLeft, initialElementTop;

                element.addEventListener("mousedown", dragStart);

                function dragStart(e) {
                    if (e.target.closest('a, button, .close-button')) return;
                    isDragging = true;
                    element.style.cursor = 'grabbing';
                    element.style.zIndex = 1001;
                    const rect = element.getBoundingClientRect();
                    initialElementLeft = rect.left;
                    initialElementTop = rect.top;
                    initialMouseX = e.clientX;
                    initialMouseY = e.clientY;
                    e.preventDefault();
                    e.stopPropagation();
                    justEndedDrag = false;
                }

                document.addEventListener("mousemove", (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        const dx = e.clientX - initialMouseX;
                        const dy = e.clientY - initialMouseY;
                        element.style.left = `${initialElementLeft + dx}px`;
                        element.style.top = `${initialElementTop + dy}px`;
                    }
                });

                document.addEventListener("mouseup", () => {
                    if (isDragging) {
                        isDragging = false;
                        element.style.cursor = 'grab';
                        element.style.zIndex = 1000;
                        justEndedDrag = true;
                        setTimeout(() => { justEndedDrag = false; }, 100);
                    }
                });
            }

            function addClickableSpansTo(element) {
                const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
                let node;
                const nodesToProcess = [];
                while (node = walker.nextNode()) {
                    nodesToProcess.push(node);
                }

                nodesToProcess.forEach(textNode => {
                    if (/[\u0400-\u04FF]/.test(textNode.nodeValue)) {
                        const parent = textNode.parentNode;
                        const parts = textNode.nodeValue.split(/([\u0400-\u04FF]+[\u0301]?)/g);
                        
                        const fragment = document.createDocumentFragment();
                        parts.forEach(part => {
                            if (part.match(/[\u0400-\u04FF]/)) {
                                const span = document.createElement('span');
                                span.textContent = part;
                                span.className = 'word-clickable';
                                span.addEventListener('click', (event) => {
                                    event.stopPropagation();
                                    selectionPopup.classList.add('hidden');
                                    const wordForLookup = part.replace(/[\u0301]/g, '');
                                    openLookupModal(wordForLookup, event);
                                    aiCustomInput.value = wordForLookup; // Populate the input field
                                });
                                fragment.appendChild(span);
                            } else {
                                fragment.appendChild(document.createTextNode(part));
                            }
                        });
                        
                        parent.replaceChild(fragment, textNode);
                    }
                });
            }

            function processNewContent(htmlContent, isHtml = false) {
                speechSynthesis.cancel();

                if (isHtml) {
                    textDisplay.innerHTML = htmlContent;
                    addClickableSpansTo(textDisplay);
                    currentRawText = textDisplay.innerText;
                } else {
                    currentRawText = htmlContent;
                    textDisplay.innerHTML = '';
                    const parts = currentRawText.split(/([\u0400-\u04FF]+[\u0301]?|[.,!?;:()"\s\n])/g);
                    parts.forEach(part => {
                        if (part.match(/[\u0400-\u04FF]/)) {
                            const span = document.createElement('span');
                            span.textContent = part;
                            span.className = 'word-clickable';
                            span.addEventListener('click', (event) => {
                                event.stopPropagation();
                                selectionPopup.classList.add('hidden');
                                const wordForLookup = part.replace(/[\u0301]/g, '');
                                openLookupModal(wordForLookup, event);
                                aiCustomInput.value = wordForLookup;
                            });
                            textDisplay.appendChild(span);
                        } else {
                            textDisplay.appendChild(document.createTextNode(part));
                        }
                    });
                }

                [aiResultsSection, explanationSection, stressedTextSection, lookupModalOverlay, selectionPopup].forEach(el => el.classList.add('hidden'));
            }

            async function getTranslation(word) {
                translateLoadingSpinner.style.display = 'block';
                selectionTranslateSpinner.style.display = 'block';
                const apiKey = "AIzaSyByK7ww7MRpFmUHJU7Mz70qj6OhjUFYMCg";
                try {
                    const prompt = `Dịch từ tiếng Nga "${word}" sang tiếng Việt. Chỉ trả về nghĩa tiếng Việt, không thêm bất kỳ văn bản giải thích nào khác.`;
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "text/plain" } };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text.trim();
                    }
                    throw new Error("Unexpected AI response structure");
                } catch (error) {
                    console.error("Error calling AI for translation:", error);
                    return `Lỗi dịch.`;
                } finally {
                    translateLoadingSpinner.style.display = 'none';
                    selectionTranslateSpinner.style.display = 'none';
                }
            }

            async function openLookupModal(word, event) {
                selectedWordModalSpan.textContent = word;
                const encodedWord = encodeURIComponent(word);
                vtudienLink.href = `https://vtudien.com/nga-viet/dictionary/nghia-cua-tu-${encodedWord}`;
                youglishLink.href = `https://youglish.com/pronounce/${encodedWord}/russian`;
                wiktionaryLink.href = `https://ru.wiktionary.org/wiki/${encodedWord}`;
                googleTranslateResultDiv.innerHTML = '';
                lookupModalOverlay.style.display = 'block';
                modalContentInner.style.visibility = 'hidden';
                const rect = event.target.getBoundingClientRect();
                const modalWidth = modalContentInner.offsetWidth;
                const modalHeight = modalContentInner.offsetHeight;
                const margin = 10;
                let top = rect.bottom + 5;
                let left = rect.left;
                if (left + modalWidth > window.innerWidth - margin) left = window.innerWidth - modalWidth - margin;
                if (left < margin) left = margin;
                if (top + modalHeight > window.innerHeight - margin) top = rect.top - modalHeight - 5;
                if (top < margin) top = margin;
                modalContentInner.style.left = `${left}px`;
                modalContentInner.style.top = `${top}px`;
                modalContentInner.style.visibility = 'visible';
                const translation = await getTranslation(word);
                googleTranslateResultDiv.innerHTML = `<strong>Dịch:</strong> ${translation}`;
            }

            makeDraggable(modalContentInner);
            makeDraggable(selectionPopup);

            document.addEventListener('mousedown', (event) => {
                if (justEndedDrag) return;

                const clickedInsideLookup = modalContentInner.contains(event.target);
                const clickedInsideSelection = selectionPopup.contains(event.target);
                const clickedOnWord = event.target.closest('.word-clickable');

                if (lookupModalOverlay.style.display === 'block' && !clickedInsideLookup && !clickedOnWord) {
                    lookupModalOverlay.style.display = 'none';
                }
                
                if (!selectionPopup.classList.contains('hidden') && !clickedInsideSelection) {
                    const selection = window.getSelection();
                    if (selection.toString().length === 0) {
                        selectionPopup.classList.add('hidden');
                    }
                }
            });

            closeLookupModalBtn.addEventListener('click', () => {
                lookupModalOverlay.style.display = 'none';
            });

            closeSelectionPopupBtn.addEventListener('click', () => {
                selectionPopup.classList.add('hidden');
            });


            async function callAI(prompt, responseMimeType, responseSchema) {
                const apiKey = "AIzaSyByK7ww7MRpFmUHJU7Mz70qj6OhjUFYMCg";
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType }
                };
                if (responseSchema) {
                    payload.generationConfig.responseSchema = responseSchema;
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.status} - ${await response.text()}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                }
                throw new Error("Unexpected AI response structure");
            }

            aiGenerateCustomButton.addEventListener('click', async () => {
                const word = aiCustomInput.value.trim();
                if (!word) {
                    alert("Vui lòng nhập một từ hoặc cụm từ.");
                    return;
                }
                loadingSpinner.style.display = 'block';
                aiResultsSection.classList.remove('hidden');
                aiTextContentDiv.innerHTML = '';
                aiGenerateCustomButton.disabled = true;
                try {
                    const prompt = `Cho từ tiếng Nga "${word}", hãy tạo ra: 8 câu ví dụ sử dụng từ này và 10 từ có cùng chủ đề với từ này. Kết quả trả về có nghĩa ngắn gọn bằng tiếng Việt. Trả về kết quả dưới dạng JSON theo cấu trúc sau: {"sentences": ["câu 1", ...], "related_words": [{"word": "từ 1 có trọng âm", "meaning": "nghĩa tiếng Việt 1"}, ...]}`;
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "sentences": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "related_words": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "word": { "type": "STRING" },
                                        "meaning": { "type": "STRING" }
                                    },
                                    "required": ["word", "meaning"]
                                }
                            }
                        }
                    };
                    const jsonString = await callAI(prompt, "application/json", schema);
                    const parsedJson = JSON.parse(jsonString);
                    
                    const sentences = Array.isArray(parsedJson.sentences) ? parsedJson.sentences : [];
                    const relatedWords = Array.isArray(parsedJson.related_words) ? parsedJson.related_words : [];

                    let htmlContent = '<h4 class="text-lg font-semibold mb-2">Câu ví dụ:</h4><ul class="list-disc list-inside space-y-1">';
                    if (sentences.length > 0) {
                        sentences.forEach(s => { htmlContent += `<li>${s.replace(/\*/g, '')}</li>`; });
                    } else {
                        htmlContent += '<li>Không có câu ví dụ nào được tạo.</li>';
                    }
                    
                    htmlContent += '</ul><h4 class="text-lg font-semibold mt-4 mb-2">Từ liên quan:</h4><ul class="list-disc list-inside space-y-1">';
                    if (relatedWords.length > 0) {
                        relatedWords.forEach(relWord => { htmlContent += `<li><strong>${relWord.word}</strong>: ${relWord.meaning}</li>`; });
                    } else {
                        htmlContent += '<li>Không có từ liên quan nào được tạo.</li>';
                    }
                    
                    htmlContent += '</ul>';
                    aiTextContentDiv.innerHTML = htmlContent;

                } catch (error) {
                    aiTextContentDiv.innerHTML = `<p class="text-red-600">Lỗi khi gọi AI: ${error.message}. Vui lòng thử lại.</p>`;
                    console.error("Error calling AI:", error);
                } finally {
                    loadingSpinner.style.display = 'none';
                    aiGenerateCustomButton.disabled = false;
                }
            });

            stressMarkButton.addEventListener('click', async () => {
                if (!currentRawText) return;
                stressMarkButton.disabled = true;
                stressedLoadingSpinner.style.display = 'block';
                stressedTextSection.classList.remove('hidden');
                stressedContentDiv.innerHTML = '';
                try {
                    const prompt = `Thêm dấu trọng âm vào văn bản tiếng Nga sau đây. Sử dụng ký tự Unicode acute accent (́) sau nguyên âm được nhấn trọng âm. Ví dụ: 'вода' -> 'вода́'. Giữ nguyên định dạng và dấu câu của văn bản gốc:\n\n${currentRawText}`;
                    const stressedText = await callAI(prompt, "text/plain");
                    stressedContentDiv.innerText = stressedText;
                    addClickableSpansTo(stressedContentDiv);
                } catch (error) {
                    stressedContentDiv.innerHTML = `<p class="text-red-600">Lỗi khi đánh trọng âm: ${error.message}.</p>`;
                } finally {
                    stressMarkButton.disabled = false;
                    stressedLoadingSpinner.style.display = 'none';
                }
            });

            explainTextButton.addEventListener('click', async () => {
                if (!currentRawText) return;
                explainTextButton.disabled = true;
                explanationLoadingSpinner.style.display = 'block';
                explanationSection.classList.remove('hidden');
                explanationContentDiv.innerHTML = '';
                try {
                    const prompt = `Giải thích nội dung ngữ pháp tiếng Nga sau đây một cách chi tiết và dễ hiểu bằng tiếng Việt, dành cho người học tiếng Nga. Tập trung vào các khái niệm ngữ pháp, ví dụ và quy tắc được trình bày trong văn bản:\n\n${currentRawText}`;
                    const explanation = await callAI(prompt, "text/plain");
                    explanationContentDiv.innerHTML = explanation.replace(/\n/g, '<br>');
                } catch (error) {
                    explanationContentDiv.innerHTML = `<p class="text-red-600">Lỗi khi gọi AI để giải thích: ${error.message}.</p>`;
                } finally {
                    explainTextButton.disabled = false;
                    explanationLoadingSpinner.style.display = 'none';
                }
            });

            fileUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                fileNameSpan.textContent = file.name;
                textInputArea.value = '';
                webUrlInput.value = '';
                textDisplay.textContent = 'Đang xử lý tệp tin...';
                const reader = new FileReader();

                if (file.name.endsWith('.docx')) {
                    reader.onload = (e) => {
                        window.mammoth.convertToHtml({ arrayBuffer: e.target.result })
                            .then(result => processNewContent(result.value, true))
                            .catch(error => {
                                console.error("Error processing DOCX:", error);
                                textDisplay.textContent = `Lỗi khi xử lý tệp DOCX: ${error.message}`;
                            });
                    };
                    reader.readAsArrayBuffer(file);
                } else { // Handle .txt files
                    reader.onload = (e) => processNewContent(e.target.result, false);
                    reader.readAsText(file);
                }
            });
            
            fetchUrlButton.addEventListener('click', async () => {
                const url = webUrlInput.value.trim();
                if (!url) {
                    alert("Vui lòng nhập một URL.");
                    return;
                }
                textInputArea.value = '';
                fileUploadInput.value = '';
                fileNameSpan.textContent = '';
                textDisplay.textContent = `Đang tải nội dung từ ${url}...`;
                try {
                    const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                    if (!response.ok) {
                        throw new Error(`Lỗi mạng: ${response.status} ${response.statusText}`);
                    }
                    const html = await response.text();
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    doc.querySelectorAll('script, style').forEach(el => el.remove());

                    let text = doc.body.innerText || "Không thể trích xuất nội dung chính.";

                    processNewContent(text, false);
                    fileNameSpan.textContent = `Nội dung từ: ${url}`;

                } catch (error) {
                    console.error("Error fetching URL:", error);
                    textDisplay.textContent = `Không thể tải nội dung từ URL. Điều này có thể do các hạn chế bảo mật (CORS) hoặc URL không hợp lệ. Lỗi: ${error.message}`;
                }
            });

            processTextButton.addEventListener('click', () => {
                const text = textInputArea.value.trim();
                if (!text) {
                    alert("Vui lòng nhập văn bản vào ô.");
                    return;
                }
                fileUploadInput.value = '';
                webUrlInput.value = '';
                fileNameSpan.textContent = 'Văn bản đã nhập';
                processNewContent(text, false);
            });

            // --- TTS Implementation ---
            function updatePlayPauseUI() {
                if (speechSynthesis.speaking && !speechSynthesis.paused) {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    playPauseText.textContent = 'Tạm dừng';
                } else {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    playPauseText.textContent = 'Phát';
                    if (!speechSynthesis.speaking) {
                        ttsProgressBar.style.width = '0%';
                    }
                }
            }

            function populateVoiceList() {
                voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('ru'));
                ttsVoiceSelect.innerHTML = '';
                if (voices.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'Không có giọng đọc tiếng Nga';
                    ttsVoiceSelect.appendChild(option);
                    return;
                }
                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-lang', voice.lang);
                    option.setAttribute('data-name', voice.name);
                    ttsVoiceSelect.appendChild(option);
                });
            }

            function speak(text, startIndex = 0) {
                speechSynthesis.cancel();
                speechStartIndex = startIndex;
                const textToSpeak = text.substring(startIndex);
                if (!textToSpeak) return;

                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                const selectedVoiceName = ttsVoiceSelect.selectedOptions[0]?.getAttribute('data-name');
                utterance.voice = voices.find(voice => voice.name === selectedVoiceName);
                utterance.rate = ttsRateSlider.value;
                utterance.lang = 'ru-RU';

                utterance.onboundary = (event) => {
                    const totalChars = currentRawText.length;
                    const spokenChars = speechStartIndex + event.charIndex;
                    const progress = totalChars > 0 ? (spokenChars / totalChars) * 100 : 0;
                    ttsProgressBar.style.width = `${progress}%`;
                };

                utterance.onend = () => {
                    ttsProgressBar.style.width = '0%';
                    speechStartIndex = 0;
                    updatePlayPauseUI();
                };

                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    updatePlayPauseUI();
                };
                
                speechSynthesis.speak(utterance);
                setTimeout(updatePlayPauseUI, 50);
            }

            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }

            ttsPlayPauseBtn.addEventListener('click', () => {
                if (!currentRawText) return;
                if (speechSynthesis.speaking) {
                    if (speechSynthesis.paused) {
                        speechSynthesis.resume();
                    } else {
                        speechSynthesis.pause();
                    }
                } else {
                    speak(currentRawText, 0);
                }
                 setTimeout(updatePlayPauseUI, 50);
            });

            ttsStopBtn.addEventListener('click', () => {
                speechSynthesis.cancel();
                ttsProgressBar.style.width = '0%';
                speechStartIndex = 0;
                updatePlayPauseUI();
            });

            ttsRateSlider.addEventListener('input', (e) => {
                const rate = parseFloat(e.target.value);
                ttsRateLabel.textContent = `${rate.toFixed(1)}x`;
                if (speechSynthesis.speaking && !speechSynthesis.paused) {
                    const currentProgress = parseFloat(ttsProgressBar.style.width) || 0;
                    const seekIndex = Math.floor((currentProgress / 100) * currentRawText.length);
                    speak(currentRawText, seekIndex);
                }
            });
            
            ttsProgressContainer.addEventListener('click', (e) => {
                if (!currentRawText) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const width = e.currentTarget.offsetWidth;
                const percentage = clickX / width;
                
                let seekIndex = Math.floor(percentage * currentRawText.length);
                
                const lastSpace = currentRawText.lastIndexOf(' ', seekIndex);
                if (lastSpace !== -1) {
                    seekIndex = lastSpace + 1;
                }

                speak(currentRawText, seekIndex);
            });


            document.querySelectorAll('.toggle-button').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.closest('.section-header').nextElementSibling;
                    content.classList.toggle('hidden');
                    button.textContent = content.classList.contains('hidden') ? 'Hiển thị' : 'Thu gọn';
                });
            });

            document.addEventListener('mouseup', (e) => {
                setTimeout(() => {
                    const selection = window.getSelection();
                    if (!selection || selection.isCollapsed) {
                        return;
                    }

                    const selectedText = selection.toString().trim();
                    const targetIsPopup = selectionPopup.contains(e.target) || modalContentInner.contains(e.target);
                    const targetIsWord = e.target.closest('.word-clickable');

                    if (!selectedText || targetIsPopup || targetIsWord) {
                        return;
                    }

                    lookupModalOverlay.style.display = 'none';
                    selectionPopup.style.visibility = 'hidden';
                    selectionPopup.classList.remove('hidden');
                    
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    const popupWidth = selectionPopup.offsetWidth;
                    const popupHeight = selectionPopup.offsetHeight;
                    const margin = 10;
                    let top = rect.bottom + window.scrollY + 5;
                    let left = rect.left + window.scrollX + (rect.width / 2) - (popupWidth / 2);
                    
                    if (left + popupWidth > window.innerWidth - margin) left = window.innerWidth - popupWidth - margin;
                    if (left < margin) left = margin;
                    if (top + popupHeight > window.innerHeight + window.scrollY - margin) {
                        top = rect.top + window.scrollY - popupHeight - 5;
                    }
                    if (top < window.scrollY + margin) top = window.scrollY + margin;

                    selectionPopup.style.top = `${top}px`;
                    selectionPopup.style.left = `${left}px`;
                    selectionPopup.style.visibility = 'visible';
                    
                    copySelectionButton.onclick = () => {
                        const textArea = document.createElement("textarea");
                        textArea.value = selectedText;
                        textArea.style.position = "fixed";
                        textArea.style.top = "-9999px";
                        textArea.style.left = "-9999px";
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                        }
                        document.body.removeChild(textArea);
                        selectionPopup.classList.add('hidden');
                    };

                    translateSelectionButton.onclick = async () => {
                        selectionTranslateResultDiv.classList.add('hidden');
                        selectionTranslateSpinner.style.display = 'block';
                        const translation = await getTranslation(selectedText);
                        selectionTranslateResultDiv.innerHTML = `<strong>Dịch:</strong> ${translation}`;
                        selectionTranslateResultDiv.classList.remove('hidden');
                    };
                    selectionTranslateResultDiv.classList.add('hidden');
                    selectionTranslateSpinner.style.display = 'none';
                }, 0);
            });
        }
        
        window.addEventListener('load', mainApp);

    </script>
</body>
</html>
